import randomï»¿
from telegram import Updateï»¿
from telegram.ext import ApplicationBuilder, CommandHandler, ContextTypesï»¿

# ===== æ¸¸æˆå­˜å‚¨ =====ï»¿
games = {}ï»¿
MAX_PLAYERS = 8ï»¿


# ===== å·¥å…·å‡½æ•° =====ï»¿
def mention(user_id, name="ç©å®¶"):ï»¿
Â Â Â Â return f"<a href='tg://user?id={user_id}'>{name}</a>"ï»¿


def get_game(chat_id):ï»¿
Â Â Â Â return games.get(chat_id)ï»¿


# ===== æŒ‡ä»¤ä¸€ï¼šåˆ›å»ºæ¸¸æˆ =====ï»¿
async def startgame(update: Update, context: ContextTypes.DEFAULT_TYPE):ï»¿
Â Â Â Â chat_id = update.effective_chat.idï»¿
Â Â Â Â user = update.effective_userï»¿

Â Â Â Â if chat_id in games:ï»¿
Â Â Â Â Â Â Â Â await update.message.reply_text("âš ï¸ å·²ç»æœ‰æ¸¸æˆåœ¨è¿›è¡Œä¸­")ï»¿
Â Â Â Â Â Â Â Â returnï»¿

Â Â Â Â games[chat_id] = {ï»¿
Â Â Â Â Â Â Â Â "host": user.id,ï»¿
Â Â Â Â Â Â Â Â "players": {user.id: user.first_name}ï»¿
Â Â Â Â }ï»¿

Â Â Â Â await update.message.reply_text(ï»¿
Â Â Â Â Â Â Â Â f"ğŸ® æ¸¸æˆåˆ›å»ºæˆåŠŸï¼\nä¸»æŒäººï¼š{user.first_name}\nå…¶ä»–äººå‘é€ /join åŠ å…¥ï¼ˆæœ€å¤š8äººï¼‰"ï»¿
Â Â Â Â )ï»¿


# ===== æŒ‡ä»¤äºŒï¼šåŠ å…¥ =====ï»¿
async def join(update: Update, context: ContextTypes.DEFAULT_TYPE):ï»¿
Â Â Â Â chat_id = update.effective_chat.idï»¿
Â Â Â Â user = update.effective_userï»¿

Â Â Â Â game = get_game(chat_id)ï»¿
Â Â Â Â if not game:ï»¿
Â Â Â Â Â Â Â Â await update.message.reply_text("âŒ å½“å‰æ²¡æœ‰æ¸¸æˆï¼Œè¯·å…ˆ /startgame")ï»¿
Â Â Â Â Â Â Â Â returnï»¿

Â Â Â Â if user.id in game["players"]:ï»¿
Â Â Â Â Â Â Â Â await update.message.reply_text("âš ï¸ ä½ å·²ç»åœ¨æ¸¸æˆä¸­äº†")ï»¿
Â Â Â Â Â Â Â Â returnï»¿

Â Â Â Â if len(game["players"]) >= MAX_PLAYERS:ï»¿
Â Â Â Â Â Â Â Â await update.message.reply_text("ğŸš« äººæ•°å·²æ»¡ï¼ˆæœ€å¤š8äººï¼‰")ï»¿
Â Â Â Â Â Â Â Â returnï»¿

Â Â Â Â game["players"][user.id] = user.first_nameï»¿

Â Â Â Â await update.message.reply_text(f"âœ… {user.first_name} åŠ å…¥æ¸¸æˆ")ï»¿


# ===== æŒ‡ä»¤ä¸‰ï¼šå¼€å§‹æ‘‡éª° =====ï»¿
async def roll(update: Update, context: ContextTypes.DEFAULT_TYPE):ï»¿
Â Â Â Â chat_id = update.effective_chat.idï»¿
Â Â Â Â user = update.effective_userï»¿

Â Â Â Â game = get_game(chat_id)ï»¿
Â Â Â Â if not game:ï»¿
Â Â Â Â Â Â Â Â returnï»¿

Â Â Â Â if user.id != game["host"]:ï»¿
Â Â Â Â Â Â Â Â await update.message.reply_text("âŒ åªæœ‰ä¸»æŒäººå¯ä»¥å¼€å§‹æœ¬è½®")ï»¿
Â Â Â Â Â Â Â Â returnï»¿

Â Â Â Â results = {}ï»¿
Â Â Â Â for uid in game["players"]:ï»¿
Â Â Â Â Â Â Â Â results[uid] = random.randint(0, 100)ï»¿

Â Â Â Â max_score = max(results.values())ï»¿
Â Â Â Â min_score = min(results.values())ï»¿

Â Â Â Â winners = [uid for uid, v in results.items() if v == max_score]ï»¿
Â Â Â Â losers = [uid for uid, v in results.items() if v == min_score]ï»¿

Â Â Â Â text = "ğŸ² æœ¬è½®éª°å­ç»“æœ\n\n"ï»¿

Â Â Â Â for uid, score in results.items():ï»¿
Â Â Â Â Â Â Â Â name = game["players"][uid]ï»¿
Â Â Â Â Â Â Â Â text += f"{mention(uid, name)} ï¼š{score}\n"ï»¿

Â Â Â Â text += "\nğŸ† èƒœåˆ©è€…ï¼š\n"ï»¿
Â Â Â Â for uid in winners:ï»¿
Â Â Â Â Â Â Â Â text += f"{mention(uid, game['players'][uid])}\n"ï»¿

Â Â Â Â text += "\nğŸ’€ å¤±è´¥è€…ï¼š\n"ï»¿
Â Â Â Â for uid in losers:ï»¿
Â Â Â Â Â Â Â Â text += f"{mention(uid, game['players'][uid])}\n"ï»¿

Â Â Â Â await update.message.reply_text(text, parse_mode="HTML")ï»¿


# ===== æŒ‡ä»¤å››ï¼šè¸¢äºº =====ï»¿
async def kick(update: Update, context: ContextTypes.DEFAULT_TYPE):ï»¿
Â Â Â Â chat_id = update.effective_chat.idï»¿
Â Â Â Â user = update.effective_userï»¿
Â Â Â Â game = get_game(chat_id)ï»¿

Â Â Â Â if not game:ï»¿
Â Â Â Â Â Â Â Â returnï»¿

Â Â Â Â if user.id != game["host"]:ï»¿
Â Â Â Â Â Â Â Â await update.message.reply_text("âŒ åªæœ‰ä¸»æŒäººå¯ä»¥è¸¢äºº")ï»¿
Â Â Â Â Â Â Â Â returnï»¿

Â Â Â Â if not context.args:ï»¿
Â Â Â Â Â Â Â Â await update.message.reply_text("ç”¨æ³•ï¼š/kick ç”¨æˆ·ID")ï»¿
Â Â Â Â Â Â Â Â returnï»¿

Â Â Â Â target_id = int(context.args[0])ï»¿

Â Â Â Â if target_id not in game["players"]:ï»¿
Â Â Â Â Â Â Â Â await update.message.reply_text("âŒ æ­¤äººä¸åœ¨æ¸¸æˆä¸­")ï»¿
Â Â Â Â Â Â Â Â returnï»¿

Â Â Â Â name = game["players"].pop(target_id)ï»¿

Â Â Â Â await update.message.reply_text(f"ğŸš« {name} å·²è¢«è¸¢å‡ºæ¸¸æˆ")ï»¿


# ===== æŒ‡ä»¤äº”ï¼šç¦»å¼€ =====ï»¿
async def leave(update: Update, context: ContextTypes.DEFAULT_TYPE):ï»¿
Â Â Â Â chat_id = update.effective_chat.idï»¿
Â Â Â Â user = update.effective_userï»¿
Â Â Â Â game = get_game(chat_id)ï»¿

Â Â Â Â if not game:ï»¿
Â Â Â Â Â Â Â Â returnï»¿

Â Â Â Â if user.id not in game["players"]:ï»¿
Â Â Â Â Â Â Â Â returnï»¿

Â Â Â Â if user.id == game["host"]:ï»¿
Â Â Â Â Â Â Â Â await update.message.reply_text("âŒ ä¸»æŒäººä¸èƒ½ç›´æ¥ç¦»å¼€ï¼Œè¯·å…ˆè½¬ç§»ä¸»æŒäººæˆ–ç»“æŸæ¸¸æˆ")ï»¿
Â Â Â Â Â Â Â Â returnï»¿

Â Â Â Â game["players"].pop(user.id)ï»¿

Â Â Â Â await update.message.reply_text(f"ğŸ‘‹ {user.first_name} å·²é€€å‡ºæ¸¸æˆ")ï»¿


# ===== æŒ‡ä»¤å…­ï¼šç»“æŸæ¸¸æˆ =====ï»¿
async def end(update: Update, context: ContextTypes.DEFAULT_TYPE):ï»¿
Â Â Â Â chat_id = update.effective_chat.idï»¿
Â Â Â Â user = update.effective_userï»¿

Â Â Â Â game = get_game(chat_id)ï»¿
Â Â Â Â if not game:ï»¿
Â Â Â Â Â Â Â Â returnï»¿

Â Â Â Â if user.id != game["host"]:ï»¿
Â Â Â Â Â Â Â Â returnï»¿

Â Â Â Â del games[chat_id]ï»¿

Â Â Â Â await update.message.reply_text("ğŸ›‘ æ¸¸æˆå·²ç»“æŸ")ï»¿


# ===== æŒ‡ä»¤ä¸ƒï¼šè½¬ç§»ä¸»æŒäºº =====ï»¿
async def transfer(update: Update, context: ContextTypes.DEFAULT_TYPE):ï»¿
Â Â Â Â chat_id = update.effective_chat.idï»¿
Â Â Â Â user = update.effective_userï»¿
Â Â Â Â game = get_game(chat_id)ï»¿

Â Â Â Â if not game:ï»¿
Â Â Â Â Â Â Â Â returnï»¿

Â Â Â Â if user.id != game["host"]:ï»¿
Â Â Â Â Â Â Â Â await update.message.reply_text("âŒ åªæœ‰ä¸»æŒäººå¯ä»¥è½¬ç§»ä¸»æŒäºº")ï»¿
Â Â Â Â Â Â Â Â returnï»¿

Â Â Â Â if not context.args:ï»¿
Â Â Â Â Â Â Â Â await update.message.reply_text("ç”¨æ³•ï¼š/transfer ç”¨æˆ·ID")ï»¿
Â Â Â Â Â Â Â Â returnï»¿

Â Â Â Â target_id = int(context.args[0])ï»¿

Â Â Â Â if target_id not in game["players"]:ï»¿
Â Â Â Â Â Â Â Â await update.message.reply_text("âŒ ç›®æ ‡ä¸åœ¨æ¸¸æˆä¸­")ï»¿
Â Â Â Â Â Â Â Â returnï»¿

Â Â Â Â game["host"] = target_idï»¿

Â Â Â Â await update.message.reply_text(f"ğŸ‘‘ ä¸»æŒäººå·²è½¬ç§»ç»™ {game['players'][target_id]}")ï»¿


# ===== å¯åŠ¨ =====ï»¿
def main():ï»¿
Â Â Â Â app = ApplicationBuilder().token("8486507377:AAFJAiCWGYziwbfIvtyihkV3oMEzGdmU26Q").build()ï»¿

Â Â Â Â app.add_handler(CommandHandler("startgame", startgame))ï»¿
Â Â Â Â app.add_handler(CommandHandler("join", join))ï»¿
Â Â Â Â app.add_handler(CommandHandler("roll", roll))ï»¿
Â Â Â Â app.add_handler(CommandHandler("kick", kick))ï»¿
Â Â Â Â app.add_handler(CommandHandler("leave", leave))ï»¿
Â Â Â Â app.add_handler(CommandHandler("end", end))ï»¿
Â Â Â Â app.add_handler(CommandHandler("transfer", transfer))ï»¿

Â Â Â Â print("Bot running...")ï»¿
Â Â Â Â app.run_polling()ï»¿


if __name__ == "__main__":ï»¿
Â Â Â Â main()